<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bayesian Court Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .game-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .hidden {
            display: none;
        }

        /* Setup Section */
        .setup-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 20px;
        }

        .setup-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .setup-card h3 {
            color: #495057;
            margin-bottom: 15px;
            border-bottom: 2px solid #6c757d;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        /* Game List */
        .games-list {
            display: grid;
            gap: 15px;
        }

        .game-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .game-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .game-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #495057;
        }

        .game-status {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-setup { background: #e3f2fd; color: #1976d2; }
        .status-presentation { background: #f3e5f5; color: #7b1fa2; }
        .status-evidence { background: #fff3e0; color: #f57c00; }
        .status-verdict { background: #e8f5e8; color: #388e3c; }

        /* Game Play Interface */
        .game-interface {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .main-content {
            background: white;
        }

        .sidebar {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .evidence-card {
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .evidence-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .probability-input {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .probability-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .range-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .range-input input[type="range"] {
            flex: 1;
        }

        .range-value {
            min-width: 60px;
            font-weight: 600;
            color: #495057;
        }

        /* Player List */
        .players-list {
            margin-bottom: 20px;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 5px;
            margin-bottom: 5px;
            border-left: 4px solid #28a745;
        }

        .player-item.disconnected {
            border-left-color: #dc3545;
            opacity: 0.6;
        }

        .player-name {
            font-weight: 600;
        }

        .player-guilt {
            font-size: 0.9rem;
            color: #6c757d;
        }

        /* Progress and Status */
        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(45deg, #667eea, #764ba2);
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }

        .status-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* Verdict Section */
        .verdict-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }

        .verdict-title {
            font-size: 2rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .verdict-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .setup-grid, .game-interface {
                grid-template-columns: 1fr;
            }
            
            .probability-row {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öñÔ∏è Bayesian Court Game</h1>
            <p>Analyze evidence using probability and reach a verdict together</p>
        </div>

        <!-- Setup Section -->
        <div id="setup-section" class="game-section fade-in">
            <div class="setup-grid">
                <!-- Create/Join Game -->
                <div class="setup-card">
                    <h3>üéÆ Join or Create Game</h3>
                    
                    <div class="form-group">
                        <label for="player-name">Your Name:</label>
                        <input type="text" id="player-name" placeholder="Enter your name" maxlength="50">
                    </div>

                    <div class="form-group">
                        <label for="guilt-tolerance">Conviction Standard:</label>
                        <select id="guilt-tolerance">
                            <option value="10">1 in 10 (90% certainty)</option>
                            <option value="20">1 in 20 (95% certainty)</option>
                            <option value="100" selected>1 in 100 (99% certainty)</option>
                            <option value="200">1 in 200 (99.5% certainty)</option>
                            <option value="1000">1 in 1000 (99.9% certainty)</option>
                        </select>
                        <small>How many innocent people you'd accept convicting per guilty conviction</small>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="use-rating-scale" checked>
                            Use 0-10 rating scale instead of percentages
                        </label>
                    </div>

                    <button class="btn btn-primary" onclick="showGameList()">
                        View Available Games
                    </button>
                </div>

                <!-- Create New Game -->
                <div class="setup-card">
                    <h3>üìÅ Create New Game</h3>
                    
                    <div class="form-group">
                        <label for="case-file">Case File:</label>
                        <select id="case-file">
                            <option value="">Loading cases...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="max-players">Maximum Players:</label>
                        <input type="number" id="max-players" value="12" min="1" max="12">
                    </div>

                    <button class="btn btn-success" onclick="createGame()">
                        Create New Game
                    </button>
                </div>
            </div>

            <!-- Available Games -->
            <div id="games-list-container" class="hidden">
                <h3>üéØ Available Games</h3>
                <div id="games-list" class="games-list">
                    <!-- Games will be populated here -->
                </div>
                <button class="btn btn-secondary" onclick="hideGameList()">Back</button>
            </div>
        </div>

        <!-- Game Interface -->
        <div id="game-section" class="game-section hidden">
            <div class="game-interface">
                <!-- Setup Phase -->
                <div id="setup-phase" class="phase-content">
                    <h2>üéÆ Game Setup</h2>
                    <div class="status-message status-info">
                        Waiting for players to join. Once everyone is ready, you can start the game.
                    </div>
                    <div id="setup-phase-content">
                        <p>Players in the game:</p>
                        <div id="setup-players-list"></div>
                        <button class="btn btn-success" onclick="startGame()" id="start-game-btn">
                            Start Game
                        </button>
                    </div>
                </div>

                <!-- Case Presentation Phase -->
                <div id="case-presentation" class="phase-content hidden">
                    <h2>üìã Case Information</h2>
                    <div id="case-details"></div>
                    <div class="status-message status-info">
                        Waiting for all players to be ready...
                    </div>
                    <button class="btn btn-primary" onclick="advanceToEvidence()">
                        Ready to Review Evidence
                    </button>
                </div>

                <!-- Evidence Review Phase -->
                <div id="evidence-review" class="phase-content hidden">
                    <div id="current-evidence" class="evidence-card">
                        <!-- Current evidence will be displayed here -->
                    </div>

                    <div id="probability-input" class="probability-input">
                        <h4>üìä Assess the Evidence</h4>
                        <p>Rate how likely this evidence would be if the defendant is:</p>
                        
                        <div id="rating-scale-input">
                            <div class="probability-row">
                                <div class="form-group">
                                    <label>If GUILTY (0-10):</label>
                                    <div class="range-input">
                                        <input type="range" id="guilty-rating" min="0" max="10" value="5">
                                        <span class="range-value" id="guilty-rating-value">5</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>If INNOCENT (0-10):</label>
                                    <div class="range-input">
                                        <input type="range" id="innocent-rating" min="0" max="10" value="5">
                                        <span class="range-value" id="innocent-rating-value">5</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="percentage-input" class="hidden">
                            <div class="probability-row">
                                <div class="form-group">
                                    <label>P(evidence|guilty):</label>
                                    <input type="number" id="prob-guilty" min="0.001" max="0.999" step="0.001" value="0.5">
                                </div>
                                <div class="form-group">
                                    <label>P(evidence|innocent):</label>
                                    <input type="number" id="prob-innocent" min="0.001" max="0.999" step="0.001" value="0.5">
                                </div>
                            </div>
                        </div>

                        <div class="status-message status-info" id="evidence-status">
                            Submit your probability assessment for this evidence.
                        </div>

                        <button class="btn btn-primary" onclick="submitEvidenceResponse()" id="submit-evidence-btn">
                            Submit Assessment
                        </button>
                    </div>
                </div>

                <!-- Verdict Phase -->
                <div id="verdict-display" class="phase-content hidden">
                    <div class="verdict-card">
                        <div class="verdict-title" id="final-verdict">VERDICT</div>
                        <div class="verdict-stats" id="verdict-stats">
                            <!-- Verdict statistics will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <h3>üë• Players</h3>
                <div id="players-list" class="players-list">
                    <!-- Players will be listed here -->
                </div>

                <h3>üìà Progress</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <div id="progress-text">Setting up game...</div>

                <h3>‚ÑπÔ∏è Your Status</h3>
                <div id="player-status">
                    <div>Guilt Probability: <strong id="player-guilt-prob">0.1%</strong></div>
                    <div>Evidence Level: <strong id="player-evidence-db">-40.0 db</strong></div>
                    <div>Would Convict: <strong id="player-verdict">No</strong></div>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-danger" onclick="leaveGame()">
                        Leave Game
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let socket = null;
        let gameId = null;
        let playerId = null;
        let gameState = null;
        let playerState = null;

        // Rating scale mapping
        const ratingToProbability = {
            0: 0.001, 1: 0.02, 2: 0.1, 3: 0.2, 4: 0.35,
            5: 0.5, 6: 0.65, 7: 0.8, 8: 0.9, 9: 0.98, 10: 0.999
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            loadCaseFiles();
            setupEventListeners();
        });

        function initializeSocket() {
            socket = io();

            socket.on('connect', function() {
                console.log('Connected to server');
            });

            socket.on('connected', function(data) {
                playerId = data.session_id;
                console.log('Session ID:', playerId);
            });

            socket.on('join_success', function(data) {
                gameId = data.game_id;
                gameState = data.game_state;
                showGameInterface();
                updateGameDisplay();
            });

            socket.on('join_failed', function(data) {
                alert('Failed to join game: ' + data.message);
            });

            socket.on('player_joined', function(data) {
                gameState = data.game_state;
                updateGameDisplay();
                showNotification(data.player_name + ' joined the game', 'success');
            });

            socket.on('player_left', function(data) {
                gameState = data.game_state;
                updateGameDisplay();
                showNotification('A player left the game', 'warning');
            });

            socket.on('game_started', function(data) {
                gameState = data.game_state;
                updateGameDisplay();
                showNotification('Game started!', 'success');
            });

            socket.on('evidence_phase_started', function(data) {
                gameState = data.game_state;
                updateGameDisplay();
                showNotification('Evidence review phase started', 'info');
            });

            socket.on('response_submitted', function(data) {
                document.getElementById('submit-evidence-btn').disabled = true;
                document.getElementById('evidence-status').innerHTML = 
                    '<span class="loading"></span> Waiting for other players...';
            });

            socket.on('response_received', function(data) {
                updateResponseProgress(data);
            });

            socket.on('evidence_completed', function(data) {
                gameState = data.game_state;
                updateGameDisplay();
                showNotification('Moving to next evidence...', 'info');
            });

            socket.on('all_evidence_completed', function(data) {
                gameState = data.game_state;
                updateGameDisplay();
                showNotification('All evidence reviewed! Calculating verdict...', 'success');
            });

            socket.on('game_state_update', function(data) {
                gameState = data.game_state;
                playerState = data.player_state;
                updateGameDisplay();
            });

            socket.on('error', function(data) {
                alert('Error: ' + data.message);
            });
        }

        function setupEventListeners() {
            // Rating scale updates
            document.getElementById('guilty-rating').addEventListener('input', function() {
                document.getElementById('guilty-rating-value').textContent = this.value;
            });

            document.getElementById('innocent-rating').addEventListener('input', function() {
                document.getElementById('innocent-rating-value').textContent = this.value;
            });

            // Input method toggle
            document.getElementById('use-rating-scale').addEventListener('change', function() {
                toggleInputMethod();
            });
        }

        function loadCaseFiles() {
            fetch('/api/case-files')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('case-file');
                    select.innerHTML = '';
                    
                    if (data.success) {
                        data.case_files.forEach(file => {
                            const option = document.createElement('option');
                            option.value = file.filename;
                            option.textContent = file.filename + (file.is_valid ? '' : ' (Invalid)');
                            option.disabled = !file.is_valid;
                            select.appendChild(option);
                        });
                    } else {
                        select.innerHTML = '<option value="">Error loading case files</option>';
                    }
                })
                .catch(error => {
                    console.error('Error loading case files:', error);
                    document.getElementById('case-file').innerHTML = '<option value="">Error loading case files</option>';
                });
        }

        function showGameList() {
            fetch('/api/games')
                .then(response => response.json())
                .then(data => {
                    const gamesList = document.getElementById('games-list');
                    gamesList.innerHTML = '';

                    if (data.success && data.games.length > 0) {
                        data.games.forEach(game => {
                            const gameCard = createGameCard(game);
                            gamesList.appendChild(gameCard);
                        });
                    } else {
                        gamesList.innerHTML = '<div class="status-message status-info">No active games available. Create a new game to get started!</div>';
                    }

                    document.getElementById('games-list-container').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error loading games:', error);
                    alert('Error loading games list');
                });
        }

        function hideGameList() {
            document.getElementById('games-list-container').classList.add('hidden');
        }

        function createGameCard(game) {
            const card = document.createElement('div');
            card.className = 'game-card';
            
            const statusClass = `status-${game.phase.replace('_', '-')}`;
            const canJoin = game.can_join;
            
            card.innerHTML = `
                <div class="game-header">
                    <div class="game-title">${game.case_name}</div>
                    <div class="game-status ${statusClass}">${game.phase.replace('_', ' ')}</div>
                </div>
                <div class="game-info">
                    <p>Players: ${game.player_count}/${game.max_players}</p>
                    <p>Game ID: ${game.game_id}</p>
                    <p>Created: ${new Date(game.created_at).toLocaleString()}</p>
                </div>
                <div style="margin-top: 15px;">
                    ${canJoin ? 
                        `<button class="btn btn-primary" onclick="joinGame('${game.game_id}')">Join Game</button>` :
                        `<button class="btn btn-secondary" disabled>Cannot Join</button>`
                    }
                </div>
            `;
            
            return card;
        }

        function createGame() {
            const caseFile = document.getElementById('case-file').value;
            const maxPlayers = parseInt(document.getElementById('max-players').value);
            
            if (!caseFile) {
                alert('Please select a case file');
                return;
            }

            fetch('/api/games', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    case_file: caseFile,
                    max_players: maxPlayers
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    joinGame(data.game_id);
                } else {
                    alert('Failed to create game: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error creating game:', error);
                alert('Error creating game');
            });
        }

        function joinGame(gameIdToJoin) {
            const playerName = document.getElementById('player-name').value.trim();
            const guiltTolerance = parseInt(document.getElementById('guilt-tolerance').value);
            const useRatingScale = document.getElementById('use-rating-scale').checked;

            if (!playerName) {
                alert('Please enter your name');
                return;
            }

            socket.emit('join_game', {
                game_id: gameIdToJoin,
                player_name: playerName,
                guilt_tolerance: guiltTolerance,
                use_rating_scale: useRatingScale
            });
        }

        function leaveGame() {
            if (confirm('Are you sure you want to leave the game?')) {
                socket.emit('leave_game');
                showSetupInterface();
            }
        }

        function advanceToEvidence() {
            socket.emit('advance_to_evidence', { game_id: gameId });
        }

        function startGame() {
            socket.emit('start_game', { game_id: gameId });
        }

        function submitEvidenceResponse() {
            const useRatingScale = document.getElementById('use-rating-scale').checked;
            let probGuilty, probInnocent, guiltyRating, innocentRating;

            if (useRatingScale) {
                guiltyRating = parseInt(document.getElementById('guilty-rating').value);
                innocentRating = parseInt(document.getElementById('innocent-rating').value);
                probGuilty = ratingToProbability[guiltyRating];
                probInnocent = ratingToProbability[innocentRating];
            } else {
                probGuilty = parseFloat(document.getElementById('prob-guilty').value);
                probInnocent = parseFloat(document.getElementById('prob-innocent').value);
            }

            socket.emit('submit_evidence_response', {
                prob_guilty: probGuilty,
                prob_innocent: probInnocent,
                guilty_rating: guiltyRating,
                innocent_rating: innocentRating
            });
        }

        function showSetupInterface() {
            document.getElementById('setup-section').classList.remove('hidden');
            document.getElementById('game-section').classList.add('hidden');
            gameId = null;
            gameState = null;
            playerState = null;
        }

        function showGameInterface() {
            document.getElementById('setup-section').classList.add('hidden');
            document.getElementById('game-section').classList.remove('hidden');
        }

        function toggleInputMethod() {
            const useRatingScale = document.getElementById('use-rating-scale').checked;
            const ratingInput = document.getElementById('rating-scale-input');
            const percentageInput = document.getElementById('percentage-input');

            if (useRatingScale) {
                ratingInput.classList.remove('hidden');
                percentageInput.classList.add('hidden');
            } else {
                ratingInput.classList.add('hidden');
                percentageInput.classList.remove('hidden');
            }
        }

        function updateGameDisplay() {
            if (!gameState) return;

            updatePlayersList();
            updateProgress();
            updatePhaseDisplay();
            
            if (playerState) {
                updatePlayerStatus();
            }
        }

        function updatePlayersList() {
            const playersList = document.getElementById('players-list');
            playersList.innerHTML = '';

            Object.entries(gameState.players).forEach(([pid, player]) => {
                const playerItem = document.createElement('div');
                playerItem.className = 'player-item' + (player.is_connected ? '' : ' disconnected');
                
                playerItem.innerHTML = `
                    <div>
                        <div class="player-name">${player.name}</div>
                        <div class="player-guilt">${player.current_guilt_probability.toFixed(2)}% guilt</div>
                    </div>
                    <div>${player.is_connected ? 'üü¢' : 'üî¥'}</div>
                `;
                
                playersList.appendChild(playerItem);
            });
        }

        function updateProgress() {
            const totalSteps = gameState.total_evidence_count + 2; // +2 for setup and verdict
            let currentStep = 0;
            
            if (gameState.phase === 'case_presentation') currentStep = 1;
            else if (gameState.phase === 'evidence_review') currentStep = 2 + gameState.current_evidence_index;
            else if (gameState.phase === 'verdict') currentStep = totalSteps;
            
            const progressPercentage = (currentStep / totalSteps) * 100;
            document.getElementById('progress-fill').style.width = progressPercentage + '%';
            
            let progressText = '';
            if (gameState.phase === 'setup') progressText = 'Setting up game...';
            else if (gameState.phase === 'case_presentation') progressText = 'Reviewing case details';
            else if (gameState.phase === 'evidence_review') {
                progressText = `Evidence ${gameState.current_evidence_index + 1} of ${gameState.total_evidence_count}`;
            } else if (gameState.phase === 'verdict') progressText = 'Final verdict';
            
            document.getElementById('progress-text').textContent = progressText;
        }

        function updatePhaseDisplay() {
            // Hide all phase content
            document.querySelectorAll('.phase-content').forEach(el => el.classList.add('hidden'));
            
            if (gameState.phase === 'setup') {
                document.getElementById('setup-phase').classList.remove('hidden');
                updateSetupDisplay();
            } else if (gameState.phase === 'case_presentation') {
                document.getElementById('case-presentation').classList.remove('hidden');
                updateCaseDisplay();
            } else if (gameState.phase === 'evidence_review') {
                document.getElementById('evidence-review').classList.remove('hidden');
                updateEvidenceDisplay();
            } else if (gameState.phase === 'verdict') {
                document.getElementById('verdict-display').classList.remove('hidden');
                updateVerdictDisplay();
            }
        }

        function updateSetupDisplay() {
            const setupPlayersList = document.getElementById('setup-players-list');
            setupPlayersList.innerHTML = '';

            Object.entries(gameState.players).forEach(([pid, player]) => {
                const playerItem = document.createElement('div');
                playerItem.className = 'player-item';
                
                playerItem.innerHTML = `
                    <div>
                        <div class="player-name">${player.name}</div>
                    </div>
                    <div>üü¢</div>
                `;
                
                setupPlayersList.appendChild(playerItem);
            });
        }

        function updateCaseDisplay() {
            const caseDetails = document.getElementById('case-details');
            const caseInfo = gameState.case_info;
            const priorInfo = gameState.prior_info;
            
            caseDetails.innerHTML = `
                <div class="evidence-card">
                    <h3>${caseInfo.name}</h3>
                    <p>${caseInfo.description}</p>
                    <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <strong>Initial Probability:</strong><br>
                        Prior odds: ${priorInfo.odds}<br>
                        Evidence level: ${priorInfo.db} decibels
                        ${priorInfo.reasoning ? '<br><br><em>' + priorInfo.reasoning + '</em>' : ''}
                    </div>
                </div>
            `;
        }

        function updateEvidenceDisplay() {
            if (!gameState.current_evidence) return;
            
            const currentEvidence = document.getElementById('current-evidence');
            const evidence = gameState.current_evidence;
            
            // Only update the evidence display if it's different from what's currently shown
            const currentEvidenceTitle = currentEvidence.querySelector('.evidence-title');
            if (!currentEvidenceTitle || currentEvidenceTitle.textContent !== evidence.name) {
                currentEvidence.innerHTML = `
                    <div class="evidence-title">${evidence.name}</div>
                    <p>${evidence.description}</p>
                    ${evidence.explanation ? '<div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;"><strong>Context:</strong> ' + evidence.explanation + '</div>' : ''}
                `;
                
                // Reset input form only when moving to new evidence
                document.getElementById('submit-evidence-btn').disabled = false;
                document.getElementById('evidence-status').innerHTML = 'Submit your probability assessment for this evidence.';
                document.getElementById('evidence-status').className = 'status-message status-info';
                
                // Reset input values only when moving to new evidence
                document.getElementById('guilty-rating').value = 5;
                document.getElementById('innocent-rating').value = 5;
                document.getElementById('guilty-rating-value').textContent = '5';
                document.getElementById('innocent-rating-value').textContent = '5';
                document.getElementById('prob-guilty').value = 0.5;
                document.getElementById('prob-innocent').value = 0.5;
            }
        }

        function updateVerdictDisplay() {
            if (!gameState.verdict) return;
            
            const verdict = gameState.verdict;
            document.getElementById('final-verdict').textContent = verdict.group_verdict;
            
            const verdictStats = document.getElementById('verdict-stats');
            verdictStats.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${verdict.average_evidence_db.toFixed(1)} db</div>
                    <div class="stat-label">Average Evidence Level</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${verdict.statistics.guilty_votes}</div>
                    <div class="stat-label">Guilty Votes</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${verdict.statistics.not_guilty_votes}</div>
                    <div class="stat-label">Not Guilty Votes</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${verdict.statistics.average_guilt_probability.toFixed(2)}%</div>
                    <div class="stat-label">Average Guilt Probability</div>
                </div>
            `;
        }

        function updatePlayerStatus() {
            if (!playerState) return;
            
            document.getElementById('player-guilt-prob').textContent = 
                playerState.current_guilt_probability.toFixed(2) + '%';
            document.getElementById('player-evidence-db').textContent = 
                playerState.current_evidence_db.toFixed(1) + ' db';
            document.getElementById('player-verdict').textContent = 
                playerState.would_convict ? 'Yes' : 'No';
        }

        function updateResponseProgress(data) {
            const status = document.getElementById('evidence-status');
            status.innerHTML = `Responses received: ${data.responses_received}/${data.total_players}`;
            
            if (data.all_responded) {
                status.innerHTML += '<br>All players responded! Processing...';
                status.className = 'status-message status-success';
            }
        }

        function showNotification(message, type = 'info') {
            // Simple notification system - could be enhanced with a proper toast library
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Request updated game state periodically
        setInterval(() => {
            if (gameId && socket.connected) {
                socket.emit('get_game_state', { game_id: gameId });
            }
        }, 5000);
    </script>
</body>
</html>